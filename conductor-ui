#!/usr/bin/env python3
"""
Conductor Linux - TUI Dashboard
A visual interface to monitor and manage Claude Code agents.
"""

import subprocess
import json
from pathlib import Path
from datetime import datetime
from textual.app import App, ComposeResult
from textual.containers import Container, Horizontal, Vertical
from textual.widgets import Header, Footer, Static, ListView, ListItem, Label, Log
from textual.reactive import reactive
from textual.timer import Timer

CONDUCTOR_HOME = Path.home() / ".conductor"
CONFIG_FILE = CONDUCTOR_HOME / "config.json"

def load_config() -> dict:
    if CONFIG_FILE.exists():
        return json.loads(CONFIG_FILE.read_text())
    return {"repos": {}, "agents": {}}

def run_cmd(cmd: str, cwd=None) -> str:
    result = subprocess.run(cmd, shell=True, cwd=cwd, capture_output=True, text=True)
    return result.stdout

def get_active_agents() -> list:
    result = run_cmd("tmux list-sessions -F '#{session_name}' 2>/dev/null")
    if not result.strip():
        return []

    config = load_config()
    agents = []

    for session in result.strip().split('\n'):
        if session.startswith("conductor-") and session in config.get("agents", {}):
            agent_info = config["agents"][session]

            # Get git status
            git_status = run_cmd("git status --porcelain", cwd=agent_info['worktree'])
            changes = len([l for l in git_status.strip().split('\n') if l])

            agents.append({
                "session": session,
                "repo": agent_info["repo"],
                "branch": agent_info["branch"],
                "worktree": agent_info["worktree"],
                "task": agent_info.get("task", ""),
                "changes": changes,
            })

    return agents

def get_agent_logs(session: str, lines: int = 100) -> str:
    return run_cmd(f"tmux capture-pane -t {session} -p -S -{lines} 2>/dev/null")


class AgentItem(ListItem):
    """A single agent in the sidebar."""

    def __init__(self, agent: dict, index: int):
        super().__init__()
        self.agent = agent
        self.index = index

    def compose(self) -> ComposeResult:
        status = "[green]●[/]" if True else "[red]●[/]"
        changes = f"[yellow]+{self.agent['changes']}[/]" if self.agent['changes'] else "[dim]clean[/]"
        yield Label(f"{status} [{self.index}] {self.agent['repo']}:{self.agent['branch']} {changes}")


class Sidebar(Vertical):
    """Left sidebar showing all agents."""

    def compose(self) -> ComposeResult:
        yield Static("[bold cyan]AGENTS[/]", classes="sidebar-title")
        yield ListView(id="agent-list")


class LogPanel(Vertical):
    """Main panel showing agent logs."""

    def compose(self) -> ComposeResult:
        yield Static("[bold]Select an agent to view logs[/]", id="log-header")
        yield Log(id="log-view", highlight=True, markup=True)


class StatusBar(Static):
    """Bottom status bar."""

    def __init__(self):
        super().__init__("")
        self.agent_count = 0

    def update_status(self, count: int):
        self.agent_count = count
        self.update(f" [bold]{count}[/] agent(s) running | [dim]r[/]=refresh [dim]a[/]=attach [dim]k[/]=kill [dim]q[/]=quit")


class ConductorUI(App):
    """Main Conductor TUI application."""

    CSS = """
    Screen {
        layout: horizontal;
    }

    Sidebar {
        width: 35;
        border: solid green;
        height: 100%;
    }

    .sidebar-title {
        text-align: center;
        padding: 1;
        background: $surface;
    }

    LogPanel {
        width: 1fr;
        border: solid cyan;
    }

    #log-header {
        padding: 1;
        background: $surface;
        text-align: center;
    }

    #log-view {
        height: 1fr;
        padding: 1;
    }

    ListView {
        height: 1fr;
    }

    ListItem {
        padding: 0 1;
    }

    ListItem:hover {
        background: $surface-lighten-1;
    }

    ListView > ListItem.--highlight {
        background: $primary 30%;
    }
    """

    BINDINGS = [
        ("q", "quit", "Quit"),
        ("r", "refresh", "Refresh"),
        ("a", "attach", "Attach"),
        ("k", "kill_agent", "Kill"),
    ]

    selected_agent = reactive(None)

    def compose(self) -> ComposeResult:
        yield Header(show_clock=True)
        with Horizontal():
            yield Sidebar()
            yield LogPanel()
        yield StatusBar()

    def on_mount(self) -> None:
        self.refresh_agents()
        self.set_interval(3, self.refresh_agents)
        self.set_interval(1, self.refresh_logs)

    def refresh_agents(self) -> None:
        agents = get_active_agents()
        agent_list = self.query_one("#agent-list", ListView)
        agent_list.clear()

        for i, agent in enumerate(agents, 1):
            agent_list.append(AgentItem(agent, i))

        status_bar = self.query_one(StatusBar)
        status_bar.update_status(len(agents))

        # Store agents for later use
        self._agents = agents

    def refresh_logs(self) -> None:
        if self.selected_agent:
            logs = get_agent_logs(self.selected_agent['session'])
            log_view = self.query_one("#log-view", Log)
            log_view.clear()
            log_view.write(logs)

    def on_list_view_selected(self, event: ListView.Selected) -> None:
        if isinstance(event.item, AgentItem):
            self.selected_agent = event.item.agent
            header = self.query_one("#log-header", Static)
            header.update(f"[bold cyan]{self.selected_agent['repo']}[/]:[yellow]{self.selected_agent['branch']}[/] - {self.selected_agent.get('task', 'No task')[:50]}")
            self.refresh_logs()

    def action_refresh(self) -> None:
        self.refresh_agents()
        self.refresh_logs()

    def action_attach(self) -> None:
        if self.selected_agent:
            self.exit()
            import os
            os.system(f"tmux attach -t {self.selected_agent['session']}")

    def action_kill_agent(self) -> None:
        if self.selected_agent:
            run_cmd(f"tmux kill-session -t {self.selected_agent['session']}")
            # Remove from config
            config = load_config()
            if self.selected_agent['session'] in config.get("agents", {}):
                del config["agents"][self.selected_agent['session']]
                CONFIG_FILE.write_text(json.dumps(config, indent=2))
            self.selected_agent = None
            self.refresh_agents()


def main():
    # Check if textual is installed
    try:
        from textual.app import App
    except ImportError:
        print("Textual library required. Install with:")
        print("  pip install textual")
        return

    app = ConductorUI()
    app.run()


if __name__ == "__main__":
    main()
